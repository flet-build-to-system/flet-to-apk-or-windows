name: Windows Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  BUILD_NUMBER: 1
  BUILD_VERSION: 1.0.0
  PYTHON_VERSION: '3.12.4'
  FLUTTER_VERSION: '3.38.7'

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: '**/requirements.txt'

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        # 先安装 wheel 以避免构建问题
        pip install wheel
        pip install -r requirements.txt
        # 安装特定版本的 Flet CLI 以避免已知 bug
        pip install flet==0.80.4

    - name: Setup Flutter ${{ env.FLUTTER_VERSION }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        flutter-args: "--no-version-check"
        analytics: false

    - name: 修复 Dart 路径问题
      run: |
        # 检查并修复 Dart 可执行文件的路径问题
        echo "当前 Flutter 安装路径:"
        where flutter
        
        echo "检查 Dart 可执行文件:"
        $flutterPath = "C:\hostedtoolcache\windows\flutter\stable-3.38.7-x64\bin\cache\dart-sdk\bin"
        if (Test-Path "$flutterPath\dart.EXE") {
          echo "Dart 可执行文件存在: $flutterPath\dart.EXE"
          # 创建一个正确的 dart 命令副本，避免重复扩展名问题
          Copy-Item "$flutterPath\dart.EXE" "$flutterPath\dart_no_ext" -Force
        } else {
          echo "警告: 找不到 dart.EXE"
        }
        
        # 验证 Flutter 环境
        flutter doctor -v

    - name: 清理构建缓存
      run: |
        # 清理之前的构建缓存
        if (Test-Path "build") {
          Remove-Item -Recurse -Force build
        }
        # 清理 Flutter 缓存
        flutter clean

    - name: Flet Build Windows
      env:
        PYTHONIOENCODING: UTF-8
        PYTHONUTF8: 1
        # 关键：使用更严格的环境变量避免交互
        FLET_CLI_NON_INTERACTIVE: "true"
        FLET_CLI_NO_ANIMATIONS: "true"
        # 设置系统环境变量
        CI: "true"
        DEBIAN_FRONTEND: "noninteractive"
      run: |
        # 设置编码
        chcp 65001
        
        # 配置 Flutter 避免所有交互
        flutter config --no-analytics --no-cli-animations --suppress-analytics
        
        echo "=== 开始 Windows 构建 ==="
        echo "Python 版本:"
        python --version
        echo "Flet 版本:"
        pip show flet
        echo "Flutter 版本:"
        flutter --version
        
        # 使用最小化输出构建
        flet build windows --build-number=$env:BUILD_NUMBER --build-version=$env:BUILD_VERSION --verbose
        
        # 验证构建输出
        echo "=== 验证构建结果 ==="
        $buildDir = "build\windows\runner\Release"
        if (Test-Path -Path $buildDir) {
          echo "✅ 构建成功！"
          echo "输出目录: $buildDir"
          $files = Get-ChildItem -Path $buildDir -File -Recurse
          echo "生成 $($files.Count) 个文件:"
          $files | ForEach-Object {
            echo "  - $($_.FullName.Substring($pwd.Path.Length + 1)) ($($_.Length) bytes)"
          }
        else {
          echo "❌ 构建失败 - 未找到输出目录"
          echo "检查 build 目录内容:"
          Get-ChildItem -Path "build" -Recurse | Select-Object -First 30 FullName
          exit 1
        }

    - name: Upload Windows Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: windows-app
        path: |
          build/windows/runner/Release/*.exe
          build/windows/runner/Release/*.dll
        if-no-files-found: error
        retention-days: 7

    - name: 创建 ZIP 包
      if: success()
      run: |
        # 创建包含所有依赖的完整 ZIP 包
        Compress-Archive -Path "build\windows\runner\Release\*" -DestinationPath "build\windows_app.zip" -Force
        echo "ZIP 包大小:"
        (Get-Item "build\windows_app.zip").Length

    - name: Upload ZIP Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: windows-app-zip
        path: build/windows_app.zip
        retention-days: 7
